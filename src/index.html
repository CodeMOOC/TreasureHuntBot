<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Treasure hunt is in progress! This is its current status.">
    <meta name="author" content="Saverio Delpriori">
    <link rel="apple-touch-icon" sizes="57x57" href="web/images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="web/images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="web/images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="web/images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="web/images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="web/images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="web/images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="web/images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="web/images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="web/images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="web/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="web/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="web/images/favicon-16x16.png">
    <link rel="manifest" href="web/res/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="web/images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>Treasure Hunt Satus</title>

    <!-- Bootstrap core CSS -->
    <link href="web/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="web/css/style.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body onload="setup()">

<div class="container">

    <div class="header clearfix">
        <nav>
            <ul class="nav nav-pills pull-right">
                <li role="presentation"><a href="#winner">Winner</a></li>
                <li role="presentation"><a href="#stops">Stops</a></li>
                <li role="presentation"><a href="#locations">Locations</a></li>
            </ul>
        </nav>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <h1>Urbino Treasure Hunt</h1>
        </div>
    </div>

    <div id="winner" class="row jumbotron nobackground">
        <div class="col-md-6" >
            <p class="lead">There are <span id="team-count">N</span> teams playing right now!</p>
            <p class="lead">The current winner is:</p>
            <h2 id="winner-team" class="text-primary">Pappapero</h2>
        </div>
        <div class="col-md-6"><img id="winner-avatar" src=""/></div>
    </div>

    <div id="stops" class="row vertical-bottom-space">
        <div class="col-lg-12">
            <h2>Teams last known stops</h2>
            <canvas id="teamChart" class="location-chart"></canvas>
            <script>



            </script>
        </div>
    </div>

    <div id="locations" class="row vertical-bottom-space">
        <div class="col-lg-12">
            <h2>Teams last known locations</h2>
            <div id="map" style="width:100%; height:500px;"></div>
            <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyCxUCY2sqyWHtSTR259z-4wHSqv7aQ-hU0"></script>
            <script type="text/javascript" src="web/js/markerwithlabel.js"></script>

            <script>

                var markers =  [];
                var map;
                var teamChart;

                function getRandColor(brightness){
                    // Six levels of brightness from 0 to 5, 0 being the darkest
                    var rgb = [Math.random() * 256, Math.random() * 256, Math.random() * 256];
                    var mix = [brightness*51, brightness*51, brightness*51]; //51 => 255/5
                    return [rgb[0] + mix[0], rgb[1] + mix[1], rgb[2] + mix[2]].map(function(x){ return Math.round(x/2.0)})
                }

                function getRGBA(color, opacity){
                    return "rgba(" + color.join(",") + "," + opacity + ")";
                }

                function addMarkers(locations, markers, map) {
                    for(var i = 0; i < locations.length; i++){
                        var image = 'web/images/teams-ico.png'; //may be the groups' icon
                        markers[i] = new MarkerWithLabel({
                            position: {lat: locations[i].lat, lng: locations[i].lng},
                            map: map,
                            icon: getAvatarUrl(locations[i].team, "70x70"),
                            //animation: google.maps.Animation.DROP,
                            labelContent: locations[i].team,
                            labelAnchor: new google.maps.Point(150, 0),
                            labelClass: "labels"
                        });
                    }
                }

                function cleanMarkers(markers){
                    for(var i = 0; i < markers.length; i++){
                        markers[i].setMap(null);
                    }
                    markers = [];
                }

                function getWinner(data){
                    var winner = "";
                    var max_pos = 0;

                    for(var i = 0; i < data.length; i++){
                        if(max_pos < data[i].pos){
                            winner = data[i].team;
                            max_pos = data[i].pos;
                        }
                    }

                    return winner;
                }

                function getLabels(data){
                    var labels = [];

                    for(var i = 0; i < data.length; i++){
                        labels[i] = data[i].team;
                    }

                    return labels;
                }

                function getChartDataset(data){
                    var dataset = [];

                    for(var i = 0; i < data.length; i++){
                        dataset[i] = data[i].pos;
                    }

                    return dataset;
                }

                function getAvatarUrl(team, size) {

                    size = size || "100x100";

                    return "https://robohash.org/" + encodeURIComponent(team) + ".png?size=" + size;
                }

                function updateWinner(winner, team_count){
                    document.getElementById("team-count").textContent = team_count;
                    document.getElementById("winner-team").textContent = winner;
                    document.getElementById("winner-avatar").src = getAvatarUrl(winner, "150x150");
                }

                function updateChart(avatars, chartDataset){

                    var colors = adaptColors(avatars.length, teamChart.data.datasets[0].backgroundColor, teamChart.data.datasets[0].borderColor);

                    teamChart.data.datasets[0].backgroundColor = colors.backgroundColor;
                    teamChart.data.datasets[0].borderColor = colors.borderColor;

                    teamChart.data.labels = avatars;
                    teamChart.data.datasets[0].data = chartDataset;
                    teamChart.update();
                }

                function updateMap(data) {
                    cleanMarkers(markers);
                    addMarkers(data, markers, map);
                }

                function updateUI(data){

                    //prepare data
                    var winner = getWinner(data);
                    var labels = getLabels(data);
                    var avatars = labels.map(getAvatarUrl);
                    var chartDataset = getChartDataset(data);

                    updateWinner(winner, data.length);
                    updateChart(labels, chartDataset);
                    updateMap(data);
                }


                function setupMap(locations){
                    var mapCenter = {lat: 43.726276, lng: 12.635762};

                    map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 15,
                        center: mapCenter
                    });

                    addMarkers(locations, markers, map);
                }

                function generateBarColors(count){

                    var data = {backgroundColor:[], borderColor:[]};

                    for(var i = 0; i < count; i++){
                        var c = getRandColor(5);
                        data.backgroundColor[i] = getRGBA(c,0.2) + "";
                        data.borderColor[i] = getRGBA(c,1.0) + "";
                    }

                    return data;
                }

                function adaptColors(count, backgroundColors, borderColors){
                    if(count <= backgroundColors.length){
                        return {backgroundColor: backgroundColors, borderColor: borderColors};
                    }

                    var diff_count = count -  backgroundColors.length;
                    var new_c = generateBarColors(diff_count);

                    return {backgroundColor: backgroundColors.concat(new_c.backgroundColor),
                        borderColor: borderColors.concat(new_c.borderColor)};
                }

                function updateChartSize(labels, ctx){
                    ctx.canvas.height = 50 * labels.length;
                    return ctx;
                }

                function setupChart(labels, chartDataset){

                    var colors = generateBarColors(labels.length);
                    var ctx = document.getElementById("teamChart").getContext("2d");
                    updateChartSize(labels, ctx);

                    teamChart = new Chart(ctx, {
                        type: 'horizontalBar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'last known stop',
                                data: chartDataset,
                                backgroundColor: colors.backgroundColor,
                                borderColor: colors.borderColor,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            legend: {
                                display: false
                            },
                            scales: {
                                yAxes: [{
                                    barPercentage: 0.7,
                                    categoryPercentage:1.0
                                }]
                            }
                        }
                    });
                }

                function getData(callback){

                    $.get("http://www.s-delpriori.it/teamsStatus.php", function(data, status) {
                        //alert("Data: " + data + "\nStatus: " + status);
                        if (data && status == 'success') {
                            callback(data);
                        }
                    });

                    /*$.post("web/teamStatus.php", function(data, status) {
                        alert("Data: " + data + "\nStatus: " + status);
                        if (data) {
                            callback(data);
                        }
                    });*/
                }

                function setup() {

                    getData(function (data) {

                        //prepare data
                        var winner = getWinner(data);
                        var labels = getLabels(data);
                        var chartDataset = getChartDataset(data);

                        updateWinner(winner, data.length);
                        setupChart(labels, chartDataset);
                        setupMap(data);

                        setInterval(function () {
                            getData(updateUI);

                        }, 5000);
                    });
                }
            </script>
        </div>
    </div>



    <footer class="footer">
        <p>&copy; 2017 University of Urbino, IT.</p>
    </footer>

</div> <!-- /container -->

</body>
</html>
